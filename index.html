<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì¹´ë“œ ë’¤ì§‘ê¸° ê²Œì„</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --felt: #0d3d2e;
      --felt-light: #1a5c44;
      --gold: #c9a227;
      --gold-dim: #a68b20;
      --card-front: #f5f0e6;
      --card-front-pattern: #e8e0d0;
      --card-back: linear-gradient(145deg, #2d5016 0%, #1e3d0f 100%);
      --hud-bg: rgba(0,0,0,0.35);
      --btn-green: #2d6a4f;
      --btn-green-hover: #40916c;
      --modal-bg: #0f2c22;
      --modal-border: #1a5c44;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Malgun Gothic', system-ui, sans-serif;
      background: linear-gradient(160deg, var(--felt) 0%, var(--felt-light) 45%, #0d3d2e 100%);
      min-height: 100vh;
      margin: 0;
      padding: 24px 16px;
      color: #f5f0e6;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .game-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .game-header h1 {
      margin: 0 0 8px;
      font-size: 2rem;
      font-weight: 800;
      color: var(--gold);
      text-shadow: 0 2px 4px rgba(0,0,0,0.4);
      letter-spacing: 0.02em;
    }
    .game-header .sub { font-size: 0.85rem; color: rgba(245,240,230,0.75); }
    .hud {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      padding: 10px 20px;
      background: var(--hud-bg);
      border-radius: 12px;
      border: 1px solid rgba(201,162,39,0.3);
      font-size: 1.05rem;
    }
    .hud span { font-weight: 600; color: var(--gold); }
    .game-board {
      background: rgba(0,0,0,0.2);
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.06);
      margin-bottom: 24px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
      max-width: 380px;
      width: 100%;
      min-height: 300px;
    }
    .card-wrap {
      aspect-ratio: 1;
      perspective: 700px;
      cursor: pointer;
      transition: transform 0.15s ease;
    }
    .card-wrap:active { transform: scale(0.96); }
    .card {
      position: relative;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card.flipped { transform: rotateY(180deg); }
    .card.matched {
      visibility: hidden;
      pointer-events: none;
    }
    .card.wrong { animation: cardShake 0.4s ease-in-out; }
    .card.match-pop { animation: matchPop 0.4s ease-out; }
    @keyframes cardShake {
      0%, 100% { transform: rotateY(180deg) translateX(0); }
      20% { transform: rotateY(180deg) translateX(-6px); }
      40% { transform: rotateY(180deg) translateX(6px); }
      60% { transform: rotateY(180deg) translateX(-4px); }
      80% { transform: rotateY(180deg) translateX(4px); }
    }
    @keyframes matchPop {
      0% { transform: rotateY(180deg) scale(1); }
      50% { transform: rotateY(180deg) scale(1.08); }
      100% { transform: rotateY(180deg) scale(1); }
    }
    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }
    .card-front {
      background: repeating-linear-gradient(
        135deg,
        var(--card-front) 0,
        var(--card-front) 2px,
        var(--card-front-pattern) 2px,
        var(--card-front-pattern) 4px
      );
      border: 2px solid var(--gold-dim);
      color: var(--gold-dim);
    }
    .card-back {
      background: var(--card-back);
      border: 2px solid var(--gold);
      transform: rotateY(180deg);
      color: #fff;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    button {
      background: var(--btn-green);
      color: #fff;
      border: none;
      padding: 14px 28px;
      font-size: 1.05rem;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    button:hover {
      background: var(--btn-green-hover);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.35);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    #startBtn { min-width: 160px; min-height: 48px; }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--modal-bg);
      padding: 28px;
      border-radius: 20px;
      max-width: 360px;
      width: 90%;
      border: 2px solid var(--modal-border);
      box-shadow: 0 16px 48px rgba(0,0,0,0.5);
    }
    .modal h2 { margin: 0 0 12px; font-size: 1.35rem; color: var(--gold); }
    .modal p { margin: 0 0 16px; color: rgba(245,240,230,0.85); font-size: 0.95rem; }
    .modal input {
      width: 100%;
      padding: 12px 14px;
      margin-bottom: 12px;
      border-radius: 10px;
      border: 2px solid var(--modal-border);
      background: rgba(0,0,0,0.3);
      color: #f5f0e6;
      font-size: 1rem;
    }
    .modal .buttons { display: flex; gap: 10px; margin-top: 16px; }
    .modal .buttons button { flex: 1; }
    .leaderboard {
      list-style: none;
      padding: 0;
      margin: 12px 0 0;
      max-height: 220px;
      overflow-y: auto;
    }
    .leaderboard li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      background: rgba(0,0,0,0.25);
      border-radius: 10px;
      margin-bottom: 8px;
      font-size: 0.95rem;
      border: 1px solid rgba(201,162,39,0.15);
    }
    .leaderboard li.rank-1 { background: linear-gradient(90deg, rgba(201,162,39,0.25), transparent); border-color: rgba(201,162,39,0.4); }
    .leaderboard li.rank-2 { background: linear-gradient(90deg, rgba(192,192,192,0.2), transparent); border-color: rgba(192,192,192,0.35); }
    .leaderboard li.rank-3 { background: linear-gradient(90deg, rgba(205,127,50,0.2), transparent); border-color: rgba(205,127,50,0.35); }
    .leaderboard li span:first-child { color: #f5f0e6; font-weight: 600; }
    .leaderboard li span:last-child { color: var(--gold); }
  </style>
</head>
<body>
  <header class="game-header">
    <h1>ğŸƒ ì¹´ë“œ ë’¤ì§‘ê¸°</h1>
    <p class="sub">ê°™ì€ ê·¸ë¦¼ì„ ì°¾ì•„ ë§ì¶° ë³´ì„¸ìš”</p>
  </header>
  <div class="hud">
    <span>ì‹œë„: <span id="moves">0</span></span>
    <span>ì‹œê°„: <span id="timer">0</span>ì´ˆ</span>
  </div>
  <div class="game-board">
    <div class="grid" id="grid"></div>
  </div>
  <button type="button" id="startBtn">ê²Œì„ ì‹œì‘</button>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h2 id="modalTitle">í´ë¦¬ì–´!</h2>
      <p id="modalMessage">ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ê¸°ë¡ì„ ì €ì¥í•˜ì„¸ìš”.</p>
      <input type="text" id="playerName" placeholder="ë‹‰ë„¤ì„" maxlength="20" />
      <div class="buttons">
        <button type="button" id="submitScore">ê¸°ë¡ ì €ì¥</button>
        <button type="button" id="closeModal">ë‹«ê¸°</button>
      </div>
      <h3 style="margin: 16px 0 8px; font-size: 1rem;">ğŸ† ìˆœìœ„í‘œ</h3>
      <ul class="leaderboard" id="leaderboard"></ul>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    function getSupabase() {
      if (window.supabaseClient) return window.supabaseClient;
      var url = typeof window.SUPABASE_URL !== 'undefined' ? window.SUPABASE_URL : '';
      var key = typeof window.SUPABASE_ANON_KEY !== 'undefined' ? window.SUPABASE_ANON_KEY : '';
      if (!url || !key) return null;
      try {
        if (window.supabase) {
          window.supabaseClient = window.supabase.createClient(url, key);
          return window.supabaseClient;
        }
      } catch (e) { console.warn('Supabase ë¡œë“œ ì‹¤íŒ¨:', e); }
      return null;
    }

    const PAIRS = 8;
    const SYMBOLS = ['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¦','ğŸ¯','ğŸ¨','ğŸ¸','ğŸµ','ğŸ”','ğŸ§','ğŸ¦„'];
    const gridEl = document.getElementById('grid');
    const movesEl = document.getElementById('moves');
    const timerEl = document.getElementById('timer');
    const startBtn = document.getElementById('startBtn');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const playerNameInput = document.getElementById('playerName');
    const submitScoreBtn = document.getElementById('submitScore');
    const closeModalBtn = document.getElementById('closeModal');
    const leaderboardEl = document.getElementById('leaderboard');

    let cards = [];
    let flipped = [];
    let moves = 0;
    let timerInterval = null;
    let timeSeconds = 0;
    let gameStarted = false;
    let scoreSavedForThisGame = false;

    function buildDeck() {
      const symbols = SYMBOLS.slice(0, PAIRS);
      const deck = [...symbols, ...symbols];
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      return deck;
    }

    function renderGrid() {
      gridEl.innerHTML = '';
      cards = buildDeck().map((symbol, i) => ({ id: i, symbol, matched: false }));
      cards.forEach((card, index) => {
        const wrap = document.createElement('div');
        wrap.className = 'card-wrap';
        wrap.innerHTML = `
          <div class="card" data-index="${index}">
            <div class="card-face card-front">?</div>
            <div class="card-face card-back">${card.symbol}</div>
          </div>
        `;
        wrap.addEventListener('click', () => handleCardClick(index));
        gridEl.appendChild(wrap);
      });
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timeSeconds = 0;
      timerEl.textContent = '0';
      timerInterval = setInterval(() => {
        timeSeconds++;
        timerEl.textContent = timeSeconds;
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function handleCardClick(index) {
      if (!gameStarted) return;
      const card = cards[index];
      if (card.matched || flipped.length === 2 || flipped.includes(index)) return;

      const wrap = gridEl.children[index];
      const cardEl = wrap.querySelector('.card');
      cardEl.classList.add('flipped');
      flipped.push(index);

      if (flipped.length === 2) {
        moves++;
        movesEl.textContent = moves;
        const [a, b] = flipped;
        if (cards[a].symbol === cards[b].symbol) {
          cards[a].matched = true;
          cards[b].matched = true;
          const cardA = gridEl.children[a].querySelector('.card');
          const cardB = gridEl.children[b].querySelector('.card');
          cardA.classList.add('match-pop');
          cardB.classList.add('match-pop');
          setTimeout(() => {
            cardA.classList.remove('match-pop');
            cardB.classList.remove('match-pop');
            cardA.classList.add('matched');
            cardB.classList.add('matched');
            flipped = [];
            if (cards.every(c => c.matched)) endGame();
          }, 400);
        } else {
          const cardA = gridEl.children[a].querySelector('.card');
          const cardB = gridEl.children[b].querySelector('.card');
          cardA.classList.add('wrong');
          cardB.classList.add('wrong');
          setTimeout(() => {
            cardA.classList.remove('wrong', 'flipped');
            cardB.classList.remove('wrong', 'flipped');
            flipped = [];
          }, 500);
        }
      }
    }

    function endGame() {
      stopTimer();
      gameStarted = false;
      scoreSavedForThisGame = false;
      submitScoreBtn.textContent = 'ê¸°ë¡ ì €ì¥';
      modalTitle.textContent = 'ğŸ‰ í´ë¦¬ì–´!';
      modalMessage.textContent = `ì‹œë„ ${moves}ë²ˆ, ${timeSeconds}ì´ˆ. ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ê¸°ë¡ì„ ì €ì¥í•˜ì„¸ìš”.`;
      playerNameInput.value = '';
      modalOverlay.classList.add('open');
      loadLeaderboard();
    }

    async function loadLeaderboard() {
      leaderboardEl.innerHTML = '';
      const supabase = getSupabase();
      if (!supabase) { leaderboardEl.innerHTML = '<li>ìˆœìœ„í‘œë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.</li>'; return; }
      const { data, error } = await supabase
        .from('card_flip_scores')
        .select('player_name, moves, time_seconds, created_at')
        .order('moves', { ascending: true })
        .order('time_seconds', { ascending: true, nullsFirst: false })
        .limit(10);
      if (error) {
        leaderboardEl.innerHTML = '<li>ìˆœìœ„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>';
        return;
      }
      (data || []).forEach((row, i) => {
        const time = row.time_seconds != null ? `${row.time_seconds}ì´ˆ` : '-';
        const li = document.createElement('li');
        if (i === 0) li.className = 'rank-1';
        else if (i === 1) li.className = 'rank-2';
        else if (i === 2) li.className = 'rank-3';
        li.innerHTML = `<span>${i + 1}. ${(row.player_name || 'ìµëª…').slice(0, 12)}</span><span>${row.moves}íšŒ / ${time}</span>`;
        leaderboardEl.appendChild(li);
      });
    }

    async function submitScore() {
      if (scoreSavedForThisGame) return;
      const supabase = getSupabase();
      if (!supabase) { alert('ìˆœìœ„ ì €ì¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.'); return; }
      const playerName = (playerNameInput.value || 'ìµëª…').trim().slice(0, 20) || 'ìµëª…';
      const { error } = await supabase.from('card_flip_scores').insert({
        player_name: playerName,
        moves,
        time_seconds: timeSeconds ?? 0
      });
      if (error) {
        alert('ì €ì¥ ì‹¤íŒ¨: ' + (error.message || 'ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'));
        return;
      }
      scoreSavedForThisGame = true;
      loadLeaderboard();
      submitScoreBtn.textContent = 'ì €ì¥ë¨!';
    }

    function startGame() {
      gameStarted = true;
      moves = 0;
      flipped = [];
      movesEl.textContent = '0';
      renderGrid();
      startTimer();
    }

    function closeModal() {
      modalOverlay.classList.remove('open');
    }

    startBtn.addEventListener('click', startGame);
    submitScoreBtn.addEventListener('click', submitScore);
    closeModalBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });

    if (leaderboardEl) loadLeaderboard();
  </script>
</body>
</html>
